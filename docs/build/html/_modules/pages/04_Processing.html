

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pages.04_Processing &mdash; D4Xgui v1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=76e2d817"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            D4Xgui
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../01_Data_IO.html">01_Data_IO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_Baseline_correction.html">03_Baseline_correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_Processing.html">04_Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_Standardization_Results.html">05_Standardization_Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_Dual_Clumped_Space.html">06_Dual_Clumped_Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_Discover_Results.html">07_Discover_Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_D47crunch_plots.html">08_D47crunch_plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../100_Save_and_Reload.html">100_Save_and_Reload</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../97_Database_Management.html">97_Database_Management</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools_Pysotope_fork.html">Pysotope_fork</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_authenticator.html">authenticator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_calc_temperature.html">calc_temperature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_commons.html">commons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_database.html">database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_init_params.html">init_params</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_page_config.html">page_config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools_sidebar_logo.html">sidebar_logo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">D4Xgui</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pages.04_Processing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pages.04_Processing</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">doctest</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocFileCase</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">D47crunch</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">D47c</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">t</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">streamlit_extras.stylable_container</span><span class="w"> </span><span class="kn">import</span> <span class="n">stylable_container</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tools.page_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">PageConfigManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.sidebar_logo</span><span class="w"> </span><span class="kn">import</span> <span class="n">SidebarLogoManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.authenticator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Authenticator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.init_params</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsotopeStandards</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tools.commons</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_session_cache</span>


<div class="viewcode-block" id="ProcessingConfig">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessingConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration class for processing parameters.&quot;&quot;&quot;</span>
    <span class="n">process_D47</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">process_D48</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">process_D49</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CDES&quot;</span>
    <span class="n">correction_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pooled&quot;</span>
    <span class="n">processing_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">drifting_sessions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">selected_calibrations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">processing_sessions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processing_sessions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drifting_sessions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drifting_sessions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_calibrations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_calibrations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">]</span></div>



<div class="viewcode-block" id="IsotopeProcessor">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IsotopeProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles isotope data processing using D47crunch.&quot;&quot;&quot;</span>
    
    <span class="c1"># Constants for isotope processing</span>
    <span class="n">ACID_TEMPERATURE</span> <span class="o">=</span> <span class="mi">90</span>  <span class="c1"># Celsius</span>
    <span class="c1">#WORKING_GAS_D13C = -4.221</span>
    <span class="c1">#WORKING_GAS_D18O = 25.26</span>
    
    <span class="c1"># Standard isotope values for different materials</span>

    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_state</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span> <span class="o">=</span> <span class="n">session_state</span>

<div class="viewcode-block" id="IsotopeProcessor.find_key_value">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor.find_key_value">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_key_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Recursively search for key in nested dict/list and return its value.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">IsotopeProcessor</span><span class="o">.</span><span class="n">find_key_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">IsotopeProcessor</span><span class="o">.</span><span class="n">find_key_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">result</span>
            <span class="k">return</span> <span class="kc">None</span></div>

        
<div class="viewcode-block" id="IsotopeProcessor._initialize_d47crunch_object">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor._initialize_d47crunch_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_d47crunch_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d47crunch_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize D47crunch object with reference samples and constants.&quot;&quot;&quot;</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">raw_data</span>
        
        <span class="c1"># Set reference sample for Levene test</span>
        <span class="k">if</span> <span class="s2">&quot;1000C&quot;</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">LEVENE_REF_SAMPLE</span> <span class="o">=</span> <span class="s2">&quot;1000C&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot;ETH-1&quot;</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">LEVENE_REF_SAMPLE</span> <span class="o">=</span> <span class="s2">&quot;ETH-1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">LEVENE_REF_SAMPLE</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Set acid reaction constant</span>
        <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">ALPHA_18O_ACID_REACTION</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="mf">3.59</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACID_TEMPERATURE</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.79e-3</span>
        <span class="p">)</span>
        
        <span class="c1"># Set nominal isotope values</span>
        <span class="c1">#d47crunch_obj.Nominal_d18O_VPDB = self.NOMINAL_D18O_VPDB.copy()</span>
        <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">Nominal_d18O_VPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;standards_bulk&#39;</span><span class="p">][</span><span class="mi">18</span><span class="p">]</span>
        <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">Nominal_d13C_VPDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;standards_bulk&#39;</span><span class="p">][</span><span class="mi">13</span><span class="p">]</span>
        <span class="c1">#d47crunch_obj.Nominal_d13C_VPDB = self.NOMINAL_D13C_VPDB.copy()</span>
        
        <span class="c1">#print(&quot;d13Cwg_VPDB:&quot;, d13Cwg_VPDB)</span>
        <span class="c1">#print(&quot;d18Owg_VSMOW:&quot;, d18Owg_VSMOW)</span>
        <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">wg</span><span class="p">()</span>
        <span class="c1">#st.write(d47crunch_obj.__dict__)</span>
        <span class="c1"># Extract and store working gas isotope values from d47crunch_obj.__dict__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;d13Cwg_VPDB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_key_value</span><span class="p">(</span><span class="n">d47crunch_obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="s2">&quot;d13Cwg_VPDB&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;d18Owg_VSMOW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_key_value</span><span class="p">(</span><span class="n">d47crunch_obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="s2">&quot;d18Owg_VSMOW&quot;</span><span class="p">)</span> <span class="c1"># Set working gas values</span></div>

       
        <span class="c1">#for record in d47crunch_obj:</span>
        <span class="c1">#    record[&quot;d13Cwg_VPDB&quot;] = self.WORKING_GAS_D13C</span>
        <span class="c1">#    record[&quot;d18Owg_VSMOW&quot;] = self.WORKING_GAS_D18O</span>
        

<div class="viewcode-block" id="IsotopeProcessor._activate_drift_corrections">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor._activate_drift_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_activate_drift_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d47crunch_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Activate drift corrections for all sessions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;scrambling_drift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;wg_drift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">d47crunch_obj</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s2">&quot;slope_drift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="IsotopeProcessor._process_isotope_data">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor._process_isotope_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_isotope_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotope_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process isotope data for specified type (D47, D48, or D49).&quot;&quot;&quot;</span>
        <span class="n">isotope_classes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;D47&quot;</span><span class="p">:</span> <span class="n">D47c</span><span class="o">.</span><span class="n">D47data</span><span class="p">,</span>
            <span class="s2">&quot;D48&quot;</span><span class="p">:</span> <span class="n">D47c</span><span class="o">.</span><span class="n">D48data</span><span class="p">,</span>
            <span class="s2">&quot;D49&quot;</span><span class="p">:</span> <span class="n">D47c</span><span class="o">.</span><span class="n">D49data</span>
        <span class="p">}</span>
        <span class="n">mz_keyditc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;D47&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\Delta_</span><span class="si">{47}</span><span class="s2">$&quot;</span><span class="p">,</span>
             <span class="s1">&#39;D48&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\Delta_</span><span class="si">{48}</span><span class="s2">$&quot;</span><span class="p">,</span>
              <span class="s1">&#39;D49&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;$\Delta_</span><span class="si">{49}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">isotope_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">isotope_classes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid isotope type: </span><span class="si">{</span><span class="n">isotope_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">mz_keyditc</span><span class="p">[</span><span class="n">isotope_type</span><span class="p">]</span><span class="si">}</span><span class="s2"> data...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create and initialize processor</span>
        <span class="n">processor</span> <span class="o">=</span> <span class="n">isotope_classes</span><span class="p">[</span><span class="n">isotope_type</span><span class="p">](</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">csv_text</span><span class="p">)</span>
        
        <span class="c1"># Set nominal values</span>
        <span class="n">nominal_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Nominal_</span><span class="si">{</span><span class="n">isotope_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">nominal_key</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="n">isotope_type</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_d47crunch_object</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
        <span class="n">processor</span><span class="o">.</span><span class="n">crunch</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">isotope_type</span> <span class="o">==</span> <span class="s2">&quot;D47&quot;</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s2">&quot;Bulk isotope processing finished!&quot;</span><span class="p">)</span>
            <span class="c1">#st.toast(f&quot;Processing Δ₄₇ data...&quot;)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_activate_drift_corrections</span><span class="p">(</span><span class="n">processor</span><span class="p">)</span>
        
        <span class="c1"># Standardize data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">correction_method</span> <span class="o">==</span> <span class="s2">&quot;pooled&quot;</span><span class="p">:</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">correction_method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">split_samples</span><span class="p">(</span><span class="n">grouping</span><span class="o">=</span><span class="s2">&quot;by_session&quot;</span><span class="p">)</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;indep_sessions&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">unsplit_samples</span><span class="p">()</span>
        
        <span class="c1"># Store session results</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">processing_sessions</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">plot_single_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">isotope_type</span><span class="si">}</span><span class="s2">_standardization_error_</span><span class="si">{</span><span class="n">session</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mz_keyditc</span><span class="p">[</span><span class="n">isotope_type</span><span class="p">]</span><span class="si">}</span><span class="s2"> processing finished!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processor</span></div>

    
<div class="viewcode-block" id="IsotopeProcessor.process_all_isotopes">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.IsotopeProcessor.process_all_isotopes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_all_isotopes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ProcessingConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process all selected isotope types.&quot;&quot;&quot;</span>
        <span class="n">clear_session_cache</span><span class="p">()</span>
        <span class="n">processors</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">isotope_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;D47&quot;</span><span class="p">,</span> <span class="s2">&quot;D48&quot;</span><span class="p">,</span> <span class="s2">&quot;D49&quot;</span><span class="p">]</span>
        <span class="n">process_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">process_D47</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">process_D48</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">process_D49</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">isotope_type</span><span class="p">,</span> <span class="n">should_process</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isotope_types</span><span class="p">,</span> <span class="n">process_flags</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">should_process</span><span class="p">:</span>
                <span class="n">processors</span><span class="p">[</span><span class="n">isotope_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_isotope_data</span><span class="p">(</span><span class="n">isotope_type</span><span class="p">)</span>
                <span class="c1"># Store with correct attribute name for merging</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_</span><span class="si">{</span><span class="n">isotope_type</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">processors</span><span class="p">[</span><span class="n">isotope_type</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_</span><span class="si">{</span><span class="n">isotope_type</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Standardization finished!&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;✅&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processors</span></div>
</div>



<div class="viewcode-block" id="TemperatureCalculator">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.TemperatureCalculator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TemperatureCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles temperature calculations from D47 values using various calibrations.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="TemperatureCalculator.calculate_swart21_temperature">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.TemperatureCalculator.calculate_swart21_temperature">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_swart21_temperature</span><span class="p">(</span><span class="n">d47_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate temperature using Swart21 calibration.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">temp_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1e6</span> <span class="o">*</span> <span class="mf">0.039</span> <span class="o">/</span> <span class="p">(</span><span class="n">d47_value</span> <span class="o">-</span> <span class="mf">0.158</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">temp_k</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TemperatureCalculator.calculate_temperature_range">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.TemperatureCalculator.calculate_temperature_range">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_temperature_range</span><span class="p">(</span><span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                                  <span class="n">calibration_func</span><span class="p">,</span> <span class="n">calibration_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate temperature ranges for a given calibration.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Define error ranges</span>
        <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">se_values</span><span class="p">,</span>
            <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
            <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
            <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
            <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">se_values</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">calibration_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">calibration_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">,</span> <span class="s2">&quot;Anderson21 (original)&quot;</span><span class="p">]:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">round</span><span class="p">(</span><span class="n">calibration_func</span><span class="p">(</span><span class="n">d47</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">round</span><span class="p">(</span><span class="n">calibration_func</span><span class="p">(</span><span class="n">d47</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span>
                <span class="p">]</span>
        
        <span class="k">return</span> <span class="n">results</span></div>
</div>



<div class="viewcode-block" id="DataProcessor">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles data merging and processing operations.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_state</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span> <span class="o">=</span> <span class="n">session_state</span>
    
<div class="viewcode-block" id="DataProcessor.smart_numeric_conversion">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor.smart_numeric_conversion">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">smart_numeric_conversion</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert series to numeric only if it contains numeric data.&quot;&quot;&quot;</span>
        <span class="c1"># Check if the series contains any numeric-like values</span>
        <span class="n">numeric_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_non_null</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">total_non_null</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Try to convert to float</span>
                    <span class="nb">float</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="n">numeric_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">pass</span>
        
        <span class="c1"># If more than 50% of non-null values are numeric, convert the column</span>
        <span class="k">if</span> <span class="n">total_non_null</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">numeric_count</span> <span class="o">/</span> <span class="n">total_non_null</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Keep as is (string or mixed type)</span>
            <span class="k">return</span> <span class="n">series</span></div>

    
<div class="viewcode-block" id="DataProcessor.apply_smart_numeric_conversion">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor.apply_smart_numeric_conversion">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_smart_numeric_conversion</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply smart numeric conversion to all columns in a DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">DataProcessor</span><span class="o">.</span><span class="n">smart_numeric_conversion</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DataProcessor.merge_datasets">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor.merge_datasets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge D47crunch outputs into unified datasets.&quot;&quot;&quot;</span>
        <span class="n">full_dataset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Process each isotope type</span>
        <span class="n">isotope_objects</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_47&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_48&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_49&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="c1"># Check which objects are available</span>
        <span class="n">available_isotopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">):</span>
            <span class="n">isotope_num</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">available_isotopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope_num</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_isotopes</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No isotope data available for merging&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Merge full datasets</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">temp_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_analysis_table</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">full_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># First dataset - take all columns</span>
                <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">temp_full</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For subsequent datasets, merge on UID and add new columns</span>
                <span class="c1"># Get columns that are not already in full_dataset (except UID)</span>
                <span class="n">existing_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">full_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">new_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">temp_full</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_cols</span> <span class="ow">or</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;UID&quot;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># More than just UID</span>
                    <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">full_dataset</span><span class="p">,</span> 
                        <span class="n">temp_full</span><span class="p">[</span><span class="n">new_cols</span><span class="p">],</span> 
                        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UID&quot;</span><span class="p">],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If no new columns, still try to merge to ensure all UIDs are included</span>
                    <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">full_dataset</span><span class="p">,</span> 
                        <span class="n">temp_full</span><span class="p">[[</span><span class="s2">&quot;UID&quot;</span><span class="p">]],</span> 
                        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UID&quot;</span><span class="p">],</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span>
                    <span class="p">)</span>
        
        <span class="c1"># Add metadata from input replicates if we have a dataset</span>
        <span class="k">if</span> <span class="n">full_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">full_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_metadata_to_dataset</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">)</span>
        
        <span class="c1"># Process summary data</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_summary_dataset</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">,</span> <span class="n">full_dataset</span><span class="p">)</span>
        
        <span class="c1"># Store results and session data</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;full_dataset&quot;</span><span class="p">:</span> <span class="n">full_dataset</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_session_data</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">,</span> <span class="n">return_dict</span><span class="p">)</span>
        
        <span class="c1"># Store all results in session state</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">return_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;correction_output_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

    
<div class="viewcode-block" id="DataProcessor._extract_analysis_table">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._extract_analysis_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_analysis_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract and format analysis table from D47crunch object.&quot;&quot;&quot;</span>
        <span class="n">temp_full</span> <span class="o">=</span> <span class="n">D47c</span><span class="o">.</span><span class="n">table_of_analyses</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">save_to_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temp_full</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">temp_full</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_smart_numeric_conversion</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DataProcessor._add_metadata_to_dataset">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._add_metadata_to_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_metadata_to_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add metadata from input replicates to the dataset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span>
            
        <span class="c1"># Ensure required columns exist</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Project&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        
        <span class="c1"># Merge with input replicate metadata</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[[</span><span class="s2">&quot;UID&quot;</span><span class="p">,</span> <span class="s2">&quot;Timetag&quot;</span><span class="p">,</span> <span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">]],</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;UID&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># Process timestamps</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_timestamps</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        
        <span class="c1"># Add d18O_VPDB column if d18O_VSMOW exists</span>
        <span class="k">if</span> <span class="s2">&quot;d18O_VSMOW&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;d18O_VPDB&quot;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;d18O_VSMOW&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.97001</span><span class="p">)</span> <span class="o">-</span> <span class="mf">29.99</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">dataset</span></div>

    
<div class="viewcode-block" id="DataProcessor._process_timestamps">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._process_timestamps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_timestamps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process and standardize timestamp formats.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Timetag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dataset</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">clean_timestamp</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Clean timestamp string for parsing.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">char</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">or</span> <span class="n">char</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Timetag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">clean_timestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Timetag&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Fallback processing without &#39;T&#39;</span>
            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Timetag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span>
                    <span class="n">clean_timestamp</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Timetag&quot;</span><span class="p">]</span>
            <span class="p">]</span>
        
        <span class="k">return</span> <span class="n">dataset</span></div>

    
<div class="viewcode-block" id="DataProcessor._create_summary_dataset">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._create_summary_dataset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_summary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotope_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> 
                               <span class="n">full_dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create summary dataset from isotope processing results.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Handle case where no full dataset exists</span>
        <span class="k">if</span> <span class="n">full_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Create aggregated dataset for d-values</span>
        <span class="n">header_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="s2">&quot;d45&quot;</span><span class="p">,</span> <span class="s2">&quot;d46&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;d47&quot;</span><span class="p">,</span> <span class="s2">&quot;d48&quot;</span><span class="p">,</span> <span class="s2">&quot;d49&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">header_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        
        <span class="c1"># Filter header_cols to only include columns that exist in full_dataset</span>
        <span class="n">available_header_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">header_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_header_cols</span><span class="p">:</span>
            <span class="c1"># If no header columns are available, create a basic summary</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Sample&quot;</span><span class="p">:</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;Sample&quot;</span> <span class="ow">in</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="p">[]})</span>
        
        <span class="n">agg_dataset</span> <span class="o">=</span> <span class="n">full_dataset</span><span class="p">[</span><span class="n">available_header_cols</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        
        <span class="c1"># Process each isotope type</span>
        <span class="n">processed_isotopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">isotope_num</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">processed_isotopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isotope_num</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">temp_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_sample_table</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">agg_dataset</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rename_summary_columns</span><span class="p">(</span><span class="n">temp_summary</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_summary_data</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">temp_summary</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process isotope D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="n">summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create empty summary if no isotopes were processed</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Sample&quot;</span><span class="p">:</span> <span class="n">agg_dataset</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]})</span>
        
        <span class="c1"># Add project and type information</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_project_type_info</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        
        <span class="c1"># Process confidence intervals</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_confidence_intervals</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        
        <span class="c1"># Add isotope ratio columns</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_isotope_ratio_columns</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">full_dataset</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">summary</span></div>

    
<div class="viewcode-block" id="DataProcessor._extract_sample_table">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._extract_sample_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_sample_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">agg_dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract sample table from D47crunch object.&quot;&quot;&quot;</span>
        <span class="n">temp_summary</span> <span class="o">=</span> <span class="n">D47c</span><span class="o">.</span><span class="n">table_of_samples</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">save_to_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temp_summary</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">temp_summary</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Sample&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use provided isotope_num or fall back to obj._4x</span>
        <span class="n">isotope_suffix</span> <span class="o">=</span> <span class="n">isotope_num</span> <span class="k">if</span> <span class="n">isotope_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">_4x</span>
        
        <span class="c1"># Check if the required column exists in agg_dataset</span>
        <span class="n">d_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">isotope_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">d_col</span> <span class="ow">in</span> <span class="n">agg_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">agg_dataset</span><span class="p">[[</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="n">d_col</span><span class="p">]],</span> 
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the d-column doesn&#39;t exist, just return the df</span>
            <span class="k">return</span> <span class="n">df</span></div>

    
<div class="viewcode-block" id="DataProcessor._rename_summary_columns">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._rename_summary_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_rename_summary_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename summary columns for specific isotope.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;SD&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;SD_D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SE&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;SE_D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;95% CL&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;95% CL_D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">})</span></div>

    
<div class="viewcode-block" id="DataProcessor._merge_summary_data">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._merge_summary_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_summary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                           <span class="n">temp_summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">isotope_num</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge summary data for additional isotope.&quot;&quot;&quot;</span>
        <span class="c1"># Define the columns we want to merge</span>
        <span class="n">base_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span>
        <span class="n">isotope_cols</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check which columns exist in temp_summary</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;SD&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;95% CL&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">temp_summary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">isotope_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isotope_cols</span><span class="p">:</span>
            <span class="c1"># If no isotope columns found, return original summary</span>
            <span class="k">return</span> <span class="n">summary</span>
        
        <span class="n">merge_cols</span> <span class="o">=</span> <span class="n">base_cols</span> <span class="o">+</span> <span class="n">isotope_cols</span>
        
        <span class="c1"># Create renamed columns for the isotope-specific data</span>
        <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">isotope_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SD&quot;</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;95% CL&quot;</span><span class="p">]:</span>
                <span class="n">rename_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_D</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">temp_summary_renamed</span> <span class="o">=</span> <span class="n">temp_summary</span><span class="p">[</span><span class="n">merge_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rename_dict</span><span class="p">:</span>
            <span class="n">temp_summary_renamed</span> <span class="o">=</span> <span class="n">temp_summary_renamed</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename_dict</span><span class="p">)</span>
        
        <span class="c1"># Perform the merge</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">temp_summary_renamed</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to merge </span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2"> data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">summary</span></div>

    
<div class="viewcode-block" id="DataProcessor._add_project_type_info">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._add_project_type_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_project_type_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add project and type information to summary.&quot;&quot;&quot;</span>
        <span class="n">project_type_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[[</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Project&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">project_type_info</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">])</span></div>

    
<div class="viewcode-block" id="DataProcessor._process_confidence_intervals">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._process_confidence_intervals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_confidence_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process confidence interval columns.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">]:</span>
            <span class="n">cl_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;95% CL_D</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">se_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;2SE_D</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">cl_col</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">cl_col</span><span class="p">:</span> <span class="n">se_col</span><span class="p">})</span>
                <span class="n">summary</span><span class="p">[</span><span class="n">se_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="n">se_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d*\.\d*)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_smart_numeric_conversion</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="DataProcessor._add_isotope_ratio_columns">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._add_isotope_ratio_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_isotope_ratio_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                  <span class="n">full_dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add isotope ratio columns to summary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">full_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">summary</span>
            
        <span class="c1"># Add d18O columns if they exist</span>
        <span class="k">if</span> <span class="s2">&quot;d18O_VSMOW&quot;</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d18O_CO2_VSMOW&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;d18O_VSMOW&quot;</span><span class="p">])</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;d18O_VSMOW&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;d18O_CO2_VPDB&quot;</span><span class="p">,</span> 
                          <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;d18O_CO2_VSMOW&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.97001</span><span class="p">)</span> <span class="o">-</span> <span class="mf">29.99</span><span class="p">)</span>
        
        <span class="c1"># Add standard deviation columns</span>
        <span class="n">sd_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;SD_d18O&quot;</span><span class="p">,</span> <span class="s2">&quot;d18O_VPDB&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;SD_d13C&quot;</span><span class="p">,</span> <span class="s2">&quot;d13C_VPDB&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">sd_col</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">sd_configs</span><span class="p">:</span>
            <span class="c1"># Check if we can insert at the specified position</span>
            <span class="n">insert_pos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_pos</span><span class="p">,</span> <span class="n">sd_col</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">))</span>
            
            <span class="c1"># Only calculate if the data column exists in full_dataset</span>
            <span class="k">if</span> <span class="n">data_col</span> <span class="ow">in</span> <span class="n">full_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]:</span>
                    <span class="n">sample_data</span> <span class="o">=</span> <span class="n">full_dataset</span><span class="p">[</span><span class="n">full_dataset</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sample_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">std_dev</span> <span class="o">=</span> <span class="n">sample_data</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                        <span class="n">summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sd_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_dev</span>
        
        <span class="k">return</span> <span class="n">summary</span></div>

    
<div class="viewcode-block" id="DataProcessor._process_session_data">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.DataProcessor._process_session_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_session_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isotope_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> 
                             <span class="n">return_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process session data for each isotope type.&quot;&quot;&quot;</span>
        <span class="n">isotope_nums</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">]</span>
        <span class="n">process_flags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;process_D</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">isotope_nums</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">should_process</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isotope_objects</span><span class="p">,</span> <span class="n">isotope_nums</span><span class="p">,</span> <span class="n">process_flags</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">should_process</span> <span class="ow">or</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Extract session data</span>
            <span class="n">sessions_data</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">table_of_sessions</span><span class="p">(</span>
                <span class="n">save_to_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span>
            <span class="p">)</span>
            <span class="n">sessions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sessions_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">columns</span><span class="o">=</span><span class="n">sessions_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">sessions_df</span> <span class="o">=</span> <span class="n">sessions_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract repeatability data</span>
            <span class="n">repeatability</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">repeatability</span>
            
            <span class="n">return_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="sa">f</span><span class="s2">&quot;sessions</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">sessions_df</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;r</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">Anchors&quot;</span><span class="p">:</span> <span class="n">repeatability</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;r_D</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">a&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s2">&quot;r</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">Sample&quot;</span><span class="p">:</span> <span class="n">repeatability</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;r_D</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">u&quot;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s2">&quot;r</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">All&quot;</span><span class="p">:</span> <span class="n">repeatability</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;r_D</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
            <span class="p">})</span>
            
            <span class="c1"># Clear the object from session state</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;D47c_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExcelExporter">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ExcelExporter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExcelExporter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles Excel file creation and export functionality.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ExcelExporter.create_excel_download">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ExcelExporter.create_excel_download">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_excel_download</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create base64 encoded Excel file from DataFrame.&quot;&quot;&quot;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">dataframe</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
            <span class="n">buffer</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ExcelExporter.create_multi_sheet_excel">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ExcelExporter.create_multi_sheet_excel">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_multi_sheet_excel</span><span class="p">(</span><span class="n">dataframes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create base64 encoded Excel file with multiple sheets.&quot;&quot;&quot;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;xlsxwriter&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span>
                    <span class="n">writer</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                    <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span>
                <span class="p">)</span>
        
        <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="ProcessingPage">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProcessingPage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class for the clumped isotope data processing page.&quot;&quot;&quot;</span>
    
    <span class="c1"># Standard samples for filtering</span>
    <span class="n">STANDARD_SAMPLES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">*</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ETH-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)],</span> 
        <span class="s2">&quot;GU1&quot;</span><span class="p">,</span> <span class="s2">&quot;Carrara&quot;</span><span class="p">,</span> <span class="s2">&quot;25C&quot;</span><span class="p">,</span> <span class="s2">&quot;1000C&quot;</span>
    <span class="p">]</span>
    
    <span class="c1"># State parameters to track</span>
    <span class="n">STATE_PARAMS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">,</span>
        <span class="s2">&quot;correction_method&quot;</span><span class="p">,</span> <span class="s2">&quot;processing_sessions&quot;</span><span class="p">,</span> <span class="s2">&quot;drifting_sessions&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the processing page.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_page</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_session_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_calibrations</span><span class="p">()</span>
        
        <span class="c1"># Initialize processors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotope_processor</span> <span class="o">=</span> <span class="n">IsotopeProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span> <span class="o">=</span> <span class="n">DataProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_calculator</span> <span class="o">=</span> <span class="n">TemperatureCalculator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span> <span class="o">=</span> <span class="n">ExcelExporter</span><span class="p">()</span>
    
<div class="viewcode-block" id="ProcessingPage._setup_page">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._setup_page">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_page</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up page configuration and authentication.&quot;&quot;&quot;</span>
        <span class="n">PageConfigManager</span><span class="p">()</span><span class="o">.</span><span class="n">configure_page</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">SidebarLogoManager</span><span class="p">()</span><span class="o">.</span><span class="n">add_logo</span><span class="p">()</span>
        
        <span class="c1"># Require authentication (skip during testing)</span>
        <span class="k">if</span> <span class="s2">&quot;PYTEST_CURRENT_TEST&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Authenticator</span><span class="p">()</span><span class="o">.</span><span class="n">require_authentication</span><span class="p">():</span>
                <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ProcessingPage._initialize_session_state">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._initialize_session_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_session_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize session state variables.&quot;&quot;&quot;</span>
        <span class="c1"># Initialize standards if not present</span>
        <span class="k">if</span> <span class="s2">&quot;standards_nominal&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span> <span class="ow">or</span> <span class="s2">&quot;standards_bulk&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_initial_standards</span><span class="p">()</span>

        
        <span class="c1"># Initialize parameters tracking</span>
        <span class="k">if</span> <span class="s2">&quot;params_last_run&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATE_PARAMS</span><span class="p">}</span>
        
        <span class="c1"># Initialize other session state variables</span>
        <span class="n">session_defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;plots_D47crunch&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;show_confirmation&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;submitted_stds&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span> <span class="ow">in</span> <span class="n">session_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ProcessingPage._initialize_calibrations">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._initialize_calibrations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_calibrations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize temperature calibrations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;04_calibs&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">D47calib</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;04_calibs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fiebig21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Anderson21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Swart21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                
                <span class="c1"># Add D47calib calibrations</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;04_calibs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (D47calib)&quot;</span><span class="p">:</span> <span class="n">obj</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">D47calib</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">D47calib</span><span class="o">.</span><span class="n">D47calib</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;D47calib module not available. Using built-in calibrations only.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;04_calibs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fiebig21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Anderson21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Swart21 (original)&quot;</span><span class="p">:</span> <span class="s2">&quot;hardcoded&quot;</span><span class="p">,</span>
                <span class="p">}</span></div>

    
<div class="viewcode-block" id="ProcessingPage._load_initial_standards">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._load_initial_standards">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_initial_standards</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load initial isotope standards.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IsotopeStandards</span><span class="o">.</span><span class="n">get_standards</span><span class="p">()</span>
        <span class="c1">#self.sss[&quot;working_gas&quot;] = IsotopeStandards.get_working_gas()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;standards_bulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IsotopeStandards</span><span class="o">.</span><span class="n">get_bulk</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">show_confirmation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Clear any cached edited text areas for standards</span>
        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">]:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;update_</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">_text&quot;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Clear last updated standards key to avoid stale state</span>
        <span class="k">if</span> <span class="s2">&quot;last_updated_stds&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;last_updated_stds&quot;</span><span class="p">]</span>
        
        <span class="c1"># Clear any JSON error messages</span>
        <span class="k">if</span> <span class="s2">&quot;error_json&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;error_json&quot;</span><span class="p">]</span>

        <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ProcessingPage._validate_input_data">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._validate_input_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that required input data is available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;input_rep&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;Please upload δ⁴⁵-δ⁴⁹ replicate data to be processed &quot;</span>
                <span class="sa">r</span><span class="s2">&quot;(:violet[Upload δ⁴⁵-δ⁴⁹ replicates] tab).&quot;</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">page_link</span><span class="p">(</span><span class="s2">&quot;pages/01_Data_IO.py&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;→ Data-IO page&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="ProcessingPage._render_input_data_editor">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._render_input_data_editor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_render_input_data_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the input data editor for outlier removal.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Input replicates (temporarily rename/delete outliers here!)&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">data_editor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">,</span>
                <span class="n">num_rows</span><span class="o">=</span><span class="s2">&quot;dynamic&quot;</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;outlier_inputReps&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

    
    
<div class="viewcode-block" id="ProcessingPage._render_sidebar_controls">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._render_sidebar_controls">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_render_sidebar_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProcessingConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render sidebar controls and return processing configuration.&quot;&quot;&quot;</span>
        <span class="c1"># Calibration selection</span>
        <span class="n">default_calibs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;04_selected_calibs&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        
        <span class="n">selected_calibs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span>
            <span class="s2">&quot;Choose calibration(s) for temperature estimates&quot;</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;04_calibs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;04_selected_calibs&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default_calibs</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="c1"># Reference frame selection</span>
        <span class="n">all_standards</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">last_std_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;last_updated_stds&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">last_std_idx</span> <span class="o">=</span> <span class="n">all_standards</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;last_updated_stds&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">last_std_idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">scale</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
            <span class="s2">&quot;**Reference frame:**&quot;</span><span class="p">,</span>
            <span class="n">all_standards</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">last_std_idx</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="c1"># Display reference frame info</span>
        <span class="k">if</span> <span class="s2">&quot;#info&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">]:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;#info&quot;</span><span class="p">])</span>
        
        <span class="c1"># Isotope selection checkboxes</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ProcessingConfig</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">config</span><span class="o">.</span><span class="n">selected_calibrations</span> <span class="o">=</span> <span class="n">selected_calibs</span>
        
        <span class="n">mz_cols</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">isotope_types</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;D47&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;D48&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;49&quot;</span><span class="p">,</span> <span class="s2">&quot;D49&quot;</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">isotope</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotope_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">mz_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">process_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;process_</span><span class="si">{</span><span class="n">isotope</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">checkbox</span><span class="p">(</span>
                        <span class="sa">rf</span><span class="s2">&quot;$\Delta_</span><span class="se">{{</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">mz</span> <span class="o">==</span> <span class="s2">&quot;47&quot;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="n">process_key</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">process_key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;process_</span><span class="si">{</span><span class="n">isotope</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        


        <span class="c1"># Standards editing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_standards_editor</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        
        <span class="c1"># Reset standards button</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_reset_standards_button</span><span class="p">()</span>
        
        <span class="c1"># Session treatment method</span>
        <span class="n">method_radio</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">radio</span><span class="p">(</span>
            <span class="s2">&quot;Treat sessions:&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;Pooled&quot;</span><span class="p">,),</span>  <span class="c1"># Independent mode disabled</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Independent mode not available, see open issue for D47crunch: &quot;</span>
                 <span class="s2">&quot;https://github.com/mdaeron/D47crunch/issues/19&quot;</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;correction_method_radio&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="n">config</span><span class="o">.</span><span class="n">correction_method</span> <span class="o">=</span> <span class="s2">&quot;pooled&quot;</span> <span class="k">if</span> <span class="n">method_radio</span> <span class="o">==</span> <span class="s2">&quot;Pooled&quot;</span> <span class="k">else</span> <span class="s2">&quot;indep_sessions&quot;</span>
        
        <span class="c1"># Session selection</span>
        <span class="n">all_sessions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">processing_sessions</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span>
            <span class="s2">&quot;Sessions to process:&quot;</span><span class="p">,</span>
            <span class="n">all_sessions</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">all_sessions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">drifting_sessions</span> <span class="o">=</span> <span class="n">all_sessions</span>
        
        <span class="k">return</span> <span class="n">config</span></div>

    
<div class="viewcode-block" id="ProcessingPage._render_standards_editor">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._render_standards_editor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_render_standards_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render standards editing interface.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">]:</span>
            <span class="n">process_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;process_D</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="n">process_key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">mz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">]):</span>
                
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$\Delta_</span><span class="se">{{</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="se">}}</span><span class="s2">$ anchors&quot;</span><span class="p">):</span>
                    <span class="n">current_standards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">][</span><span class="n">mz</span><span class="p">]</span>
                    
                    <span class="n">updated_text</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_area</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;anchors </span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_standards</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
                        <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;update_</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">_text&quot;</span><span class="p">,</span>
                        <span class="n">label_visibility</span><span class="o">=</span><span class="s2">&quot;collapsed&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;Update $\Delta_</span><span class="se">{{</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="se">}}</span><span class="s2">$ values!&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;update_</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_standards_dict</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">updated_text</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">bulk</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">18</span><span class="p">]:</span>
            <span class="c1"># Check if the isotope anchors exist in the standards dictionary for the scale</span>
            <span class="c1">#if iso in self.sss.standards_nominal[scale]:</span>
            <span class="n">key_str</span> <span class="o">=</span> <span class="sa">rf</span><span class="s2">&quot;$\delta^</span><span class="se">{{</span><span class="si">{</span><span class="n">bulk</span><span class="si">}</span><span class="se">}}</span><span class="s2">$</span><span class="si">{</span><span class="s1">&#39;O&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">bulk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2"> anchors&quot;</span><span class="p">):</span>
                <span class="n">current_standards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_bulk</span><span class="p">[</span><span class="n">bulk</span><span class="p">]</span>
                
                <span class="n">updated_text</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">text_area</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;anchors </span><span class="si">{</span><span class="n">bulk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_standards</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
                    <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;update_</span><span class="si">{</span><span class="n">bulk</span><span class="si">}</span><span class="s2">_text&quot;</span><span class="p">,</span>
                    <span class="n">label_visibility</span><span class="o">=</span><span class="s2">&quot;collapsed&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update </span><span class="si">{</span><span class="n">key_str</span><span class="si">}</span><span class="s2"> values!&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;update_</span><span class="si">{</span><span class="n">bulk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_standards_dict</span><span class="p">(</span><span class="n">bulk</span><span class="p">,</span> <span class="n">updated_text</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>


        <span class="c1"># Display JSON errors if any</span>
        <span class="k">if</span> <span class="s2">&quot;error_json&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">error</span><span class="p">,</span> <span class="n">formatted_json</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;error_json&quot;</span><span class="p">]:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON format: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;🚨&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">formatted_json</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ProcessingPage._update_standards_dict">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._update_standards_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_standards_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">json_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update standards dictionary with new values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;last_updated_stds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards_nominal</span><span class="p">[</span><span class="n">scale</span><span class="p">][</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dict</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Dictionary updated successfully!&quot;</span><span class="p">)</span>
            
            <span class="c1"># Clear any previous errors</span>
            <span class="k">if</span> <span class="s2">&quot;error_json&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">error_json</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Format error message with highlighted error line</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">json_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">lineno</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;:red[</span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lineno</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span>
            
            <span class="c1"># Add indentation to non-first/last lines</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">formatted_json</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s2">&quot;error_json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;error_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;error_json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">formatted_json</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="ProcessingPage._render_reset_standards_button">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._render_reset_standards_button">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_render_reset_standards_button</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render reset standards button with confirmation dialog.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Reset standards!&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;reset_standards&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">show_confirmation</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">show_confirmation</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Reset all standard values?&quot;</span><span class="p">)</span>
            <span class="n">confirm_col</span><span class="p">,</span> <span class="n">cancel_col</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">confirm_col</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">stylable_container</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;confirm_reset_button&quot;</span><span class="p">,</span>
                    <span class="n">css_styles</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    [data-testid=&quot;baseButton-secondary&quot;] {</span>
<span class="s2">                        background-color: red;</span>
<span class="s2">                    }</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_load_initial_standards</span><span class="p">()</span>
            
            <span class="k">with</span> <span class="n">cancel_col</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">stylable_container</span><span class="p">(</span>
                    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cancel_reset_button&quot;</span><span class="p">,</span>
                    <span class="n">css_styles</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    [data-testid=&quot;baseButton-secondary&quot;] {</span>
<span class="s2">                        background-color: grey;</span>
<span class="s2">                    }</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;No&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">show_confirmation</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ProcessingPage._prepare_processing_data">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._prepare_processing_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_processing_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ProcessingConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare data for processing.&quot;&quot;&quot;</span>
        <span class="c1"># Filter data by selected sessions</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span><span class="s2">&quot;Session&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">processing_sessions</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># Rename datetime column if present</span>
        <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;Timetag&quot;</span><span class="p">})</span>
        
        <span class="c1"># Sort by timestamp and prepare CSV</span>
        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Timetag&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">csv_text</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Update session state with current config (only non-widget bound values)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">correction_method</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">correction_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">processing_sessions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">processing_sessions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">drifting_sessions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">processing_sessions</span></div>

    
<div class="viewcode-block" id="ProcessingPage._calculate_longterm_error">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._calculate_longterm_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_longterm_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate long-term error estimates.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;correction_output_</span><span class="si">{</span><span class="n">summary_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        
        <span class="n">isotope_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;D47&quot;</span><span class="p">,</span> <span class="s2">&quot;D48&quot;</span><span class="p">,</span> <span class="s2">&quot;D49&quot;</span><span class="p">]</span>
        <span class="n">process_flags</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;process_</span><span class="si">{</span><span class="n">isotope</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">isotope</span> <span class="ow">in</span> <span class="n">isotope_types</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">isotope</span><span class="p">,</span> <span class="n">should_process</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">isotope_types</span><span class="p">,</span> <span class="n">process_flags</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">should_process</span><span class="p">:</span>
                <span class="n">isotope_num</span> <span class="o">=</span> <span class="n">isotope</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">repeatability_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;correction_output_r</span><span class="si">{</span><span class="n">isotope_num</span><span class="si">}</span><span class="s2">All&quot;</span>
                
                <span class="k">if</span> <span class="n">repeatability_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                    <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">isotope</span><span class="si">}</span><span class="s2"> 2SE (longterm)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">repeatability_key</span><span class="p">]</span>
                        <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">summary</span></div>



     
<div class="viewcode-block" id="ProcessingPage._add_fiebig21_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._add_fiebig21_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_fiebig21_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add Fiebig21 temperature calculations to summary.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize_scalar</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">tools.calc_temperature</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemperatureCalculator</span>
            
            <span class="c1"># Define error ranges for temperature calculation</span>
            <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">_2se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">_2se_values</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c1"># Calculate temperatures for each error range</span>
            <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">d47</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Calculate temperature using optimization</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span>
                                <span class="n">TemperatureCalculator</span><span class="o">.</span><span class="n">get_temperature_difference_d47_fiebig2021</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d47</span><span class="p">,),</span>
                                <span class="c1">#bounds=(-100, 1000),</span>
                                <span class="c1">#method=&#39;bounded&#39;</span>
                            <span class="p">)</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                
                <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, Fiebig21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T (°C), Fiebig21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
<div class="viewcode-block" id="ProcessingPage._add_fiebig24_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._add_fiebig24_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_fiebig24_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add Fiebig24 temperature calculations to summary.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize_scalar</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">tools.calc_temperature</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemperatureCalculator</span>
            
            <span class="c1"># Define error ranges for temperature calculation</span>
            <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">_2se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span><span class="n">_2se_values</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c1"># Calculate temperatures for each error range</span>
            <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">d47</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Calculate temperature using optimization</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span>
                                <span class="n">TemperatureCalculator</span><span class="o">.</span><span class="n">get_temperature_difference_d47_fiebig2024</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d47</span><span class="p">,),</span>
                                <span class="c1">#bounds=(0, 1000),</span>
                                <span class="c1">#method=&#39;bounded&#39;</span>
                            <span class="p">)</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                
                <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, Fiebig24 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T (°C), Fiebig24 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
<div class="viewcode-block" id="ProcessingPage._add_anderson21_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._add_anderson21_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_anderson21_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add Anderson21 temperature calculations to summary.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Anderson21 calibration: T = 0.0449 * 10^6 / D47^2 - 273.15</span>
            
            <span class="c1"># Define error ranges for temperature calculation</span>
            <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">_2se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">_2se_values</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c1"># Calculate temperatures for each error range</span>
            <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">d47</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d47</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">0.0391</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">d47</span> <span class="o">-</span><span class="mf">0.154</span><span class="p">))</span> <span class="o">-</span> <span class="mf">273.15</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                
                <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, Anderson21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T (°C), Anderson21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
    
<div class="viewcode-block" id="ProcessingPage._add_swart21_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._add_swart21_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_swart21_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add Swart21 temperature calculations to summary using the Swart21 (2021) CDES90 calibration.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">_2se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">_2se_values</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">coef</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="mf">0.039</span>  <span class="c1"># from </span>

            <span class="c1"># Calculate temperatures for each error range</span>
            <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span><span class="p">:</span>
                    <span class="n">denom</span> <span class="o">=</span> <span class="n">d47</span> <span class="o">-</span> <span class="mf">0.158</span>
                    <span class="k">if</span> <span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                        <span class="k">continue</span>
                                 
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">temp_K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">coef</span> <span class="o">/</span> <span class="n">denom</span><span class="p">)</span>
                        <span class="n">temp_C</span> <span class="o">=</span> <span class="n">temp_K</span> <span class="o">-</span> <span class="mf">273.15</span>
                        <span class="c1"># Only round/append if finite; otherwise append NaN</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">temp_C</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">temp_C</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">,</span> <span class="ne">FloatingPointError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


                <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, Swart21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># In case of an unexpected error, record it in the summary</span>
            <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T (°C), Swart21 (original)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="ProcessingPage._add_d47calib_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._add_d47calib_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_d47calib_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">calib_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add D47calib temperature calculations to summary.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the D47calib library for other calibrations</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">D47calib</span>
            
            <span class="c1"># Define error ranges for temperature calculation</span>
            <span class="n">error_ranges</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;T(min, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">_2se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(min, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">+</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(mean)&quot;</span><span class="p">:</span> <span class="n">d47_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 1SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">se_values</span><span class="p">,</span>
                <span class="s2">&quot;T(max, 2SE)&quot;</span><span class="p">:</span> <span class="n">d47_values</span> <span class="o">-</span> <span class="n">_2se_values</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="c1"># Calculate temperatures for each error range</span>
            <span class="k">for</span> <span class="n">temp_type</span><span class="p">,</span> <span class="n">d47_range</span> <span class="ow">in</span> <span class="n">error_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">d47</span> <span class="ow">in</span> <span class="n">d47_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">d47</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Calculate temperature using D47calib with the calibration object</span>
                            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;04_calibs&quot;</span><span class="p">][</span><span class="n">calib_name</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_T_from_D47&quot;</span><span class="p">](</span><span class="n">d47</span><span class="p">)</span>
                            <span class="c1">#temp = D47calib.temperature(d47, calib_obj)</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># Log the specific error for debugging</span>
                            <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                
                <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">temp_type</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">calib_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperatures</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">summary</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T (°C), </span><span class="si">{</span><span class="n">calib_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>

    
<div class="viewcode-block" id="ProcessingPage._calculate_temperatures">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._calculate_temperatures">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_temperatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate temperatures using selected calibrations.&quot;&quot;&quot;</span>
        <span class="n">calibrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;04_selected_calibs&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;04_used_calibs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">calibrations</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;D47&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">summary</span>
        
        <span class="n">d47_values</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;D47&quot;</span><span class="p">]</span>
        <span class="n">se_values</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SE_D47&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">)))</span>
        <span class="n">_2se_values</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;2SE_D47&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">)))</span>

        <span class="c1"># Process each calibration</span>
        <span class="k">for</span> <span class="n">calib_name</span> <span class="ow">in</span> <span class="n">calibrations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">calib_name</span> <span class="o">==</span> <span class="s2">&quot;Fiebig24 (original)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_fiebig24_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">,</span> <span class="n">se_values</span><span class="p">,</span><span class="n">_2se_values</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">calib_name</span> <span class="o">==</span> <span class="s2">&quot;Fiebig21 (original)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_fiebig21_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">,</span> <span class="n">se_values</span><span class="p">,</span><span class="n">_2se_values</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">calib_name</span> <span class="o">==</span> <span class="s2">&quot;Anderson21 (original)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_anderson21_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">,</span> <span class="n">se_values</span><span class="p">,</span><span class="n">_2se_values</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">calib_name</span> <span class="o">==</span> <span class="s2">&quot;Swart21 (original)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_swart21_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">,</span> <span class="n">se_values</span><span class="p">,</span><span class="n">_2se_values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_d47calib_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">d47_values</span><span class="p">,</span> <span class="n">se_values</span><span class="p">,</span> <span class="n">_2se_values</span><span class="p">,</span> <span class="n">calib_name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">summary</span></div>

   
<div class="viewcode-block" id="ProcessingPage._create_processing_params_dataframe">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._create_processing_params_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_processing_params_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a DataFrame with processing parameters.&quot;&quot;&quot;</span>

        <span class="n">IP</span> <span class="o">=</span> <span class="n">IsotopeProcessor</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Parameter&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Processing sessions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Reference frame&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;Correction method&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Standards D47&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Standards D48&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Standards D49&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D47 processed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D48 processed&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;D49 processed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D47 long-term repeatability (1sd)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D48 long-term repeatability (1sd)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;D49 long-term repeatability (1sd)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Selected calibrations&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Acid temperature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Working gas d13C&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Working gas d18O&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Standards d13C&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Standards d18O&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processing_sessions&quot;</span><span class="p">,</span> <span class="p">[])),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;Independent sessions&quot;</span> <span class="k">if</span> <span class="s2">&quot;indep&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_method&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Pooled sessions&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;47&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;47&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards</span><span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;48&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;48&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards</span><span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;49&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_nominal&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scale</span><span class="p">][</span><span class="s2">&quot;49&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards</span><span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_output_r47All&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_output_r48All&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_output_r49All&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;04_used_calibs&quot;</span><span class="p">,</span> <span class="p">[])),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">IP</span><span class="o">.</span><span class="n">ACID_TEMPERATURE</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;d13Cwg_VPDB&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">)),</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s1">&#39;d18Owg_VSMOW&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">)),</span>                
                <span class="nb">str</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_bulk&quot;</span><span class="p">][</span><span class="mi">18</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_bulk&quot;</span><span class="p">][</span><span class="mi">18</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span>
                <span class="nb">str</span><span class="p">({</span><span class="n">key</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_bulk&quot;</span><span class="p">][</span><span class="mi">13</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;standards_bulk&quot;</span><span class="p">][</span><span class="mi">13</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">input_rep</span><span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">}),</span>                
            <span class="p">]</span>
        <span class="p">}</span>
        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bg_success&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scaling factors&#39;</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">scaling_factors</span><span class="p">))</span>


        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>


    
    
<div class="viewcode-block" id="ProcessingPage._display_processing_summary">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._display_processing_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_processing_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display processing summary information.&quot;&quot;&quot;</span>
        <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">col1</span><span class="p">:</span>
            <span class="c1"># Display processing parameters</span>
            <span class="n">sessions_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s2">&quot;processing_sessions&quot;</span><span class="p">])</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed sessions: </span><span class="si">{</span><span class="n">sessions_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference frame: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">method_display</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Independent sessions&quot;</span> <span class="k">if</span> <span class="s2">&quot;indep&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s2">&quot;correction_method&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="s2">&quot;Pooled sessions&quot;</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correction method: </span><span class="si">{</span><span class="n">method_display</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create download link for full results</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_full_results_download</span><span class="p">()</span>
        
        <span class="k">with</span> <span class="n">col2</span><span class="p">:</span>
            <span class="c1"># Display repeatability metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_repeatability_metrics</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="ProcessingPage._create_full_results_download">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._create_full_results_download">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_full_results_download</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create download link for full processing results.&quot;&quot;&quot;</span>
        <span class="n">dataframes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;proc_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_processing_params_dataframe</span><span class="p">(),</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_summary&quot;</span><span class="p">],</span>
            <span class="s2">&quot;replicates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_full_dataset&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        
        <span class="c1"># Add session-specific data</span>
        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;49&quot;</span><span class="p">]:</span>
            <span class="n">process_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;process_D</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">session_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;correction_output_sessions</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">process_key</span><span class="p">)</span> <span class="ow">and</span> <span class="n">session_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">):</span>
                <span class="n">dataframes</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;session</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">session_key</span><span class="p">]</span>
        
        <span class="c1"># Generate filename</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s2">&quot;processing_sessions&quot;</span><span class="p">]</span>
        <span class="n">session_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
                <span class="n">session_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
        
        <span class="n">session_parts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">session_parts</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">session_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span><span class="si">}</span><span class="s2">sessions_&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="s1">&#39;correction_method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.xlsx&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># Create download link</span>
        <span class="n">excel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span><span class="o">.</span><span class="n">create_multi_sheet_excel</span><span class="p">(</span><span class="n">dataframes</span><span class="p">)</span>
        <span class="n">download_link</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;base64,</span><span class="si">{</span><span class="n">excel_data</span><span class="si">}</span><span class="s1">&quot; download=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&gt;📥 download full results!&lt;/a&gt;&#39;</span>
        <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ProcessingPage._display_repeatability_metrics">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._display_repeatability_metrics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_repeatability_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display repeatability metrics.&quot;&quot;&quot;</span>
        <span class="n">md_pieces</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">isotope_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;D47&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_r47All&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;D48&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_r48All&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;D49&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_r49All&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">isotope</span><span class="p">,</span> <span class="n">process_key</span><span class="p">,</span> <span class="n">repeatability_key</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isotope_configs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">,</span> <span class="n">process_key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">repeatability_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># First isotope gets the header</span>
                    <span class="n">md_pieces</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                        <span class="s2">&quot;Long-term repeatability (1sd)&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;font size=&quot;5&quot;&gt;Δ&lt;sub&gt;</span><span class="si">{</span><span class="n">isotope</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s1">&lt;/sub&gt;&lt;/font&gt;&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;font size=&quot;5&quot;&gt;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">repeatability_key</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1"> ppm&lt;/font&gt;&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">,</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">precision</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">isotope</span> <span class="o">!=</span> <span class="s2">&quot;D49&quot;</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">md_pieces</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;font size=&quot;5&quot;&gt;Δ&lt;sub&gt;</span><span class="si">{</span><span class="n">isotope</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s1">&lt;/sub&gt;&lt;/font&gt;&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;font size=&quot;5&quot;&gt;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">repeatability_key</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="p">)</span><span class="si">}</span><span class="s1"> ppm&lt;/font&gt;&#39;</span><span class="p">,</span>
                        <span class="s2">&quot;&lt;br&gt;&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">isotope_configs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">])</span>
        
        <span class="k">if</span> <span class="n">md_pieces</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">md_pieces</span><span class="p">),</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ProcessingPage._display_results_expanders">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._display_results_expanders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_results_expanders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display detailed results in expandable sections.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;correction_output_summary&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_summary&quot;</span><span class="p">]</span>
        
        <span class="c1"># Summary section</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Summary&quot;</span><span class="p">):</span>
            <span class="n">excel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span><span class="o">.</span><span class="n">create_excel_download</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">download_link</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;base64,</span><span class="si">{</span><span class="n">excel_data</span><span class="si">}</span><span class="s1">&quot; download=&quot;summary.xlsx&quot;&gt;📥 download!&lt;/a&gt;&#39;</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">))</span>
        
        <span class="c1"># Processing parameters section</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Processing parameters&quot;</span><span class="p">):</span>
            <span class="n">params_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_processing_params_dataframe</span><span class="p">()</span>
            <span class="n">excel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span><span class="o">.</span><span class="n">create_excel_download</span><span class="p">(</span><span class="n">params_df</span><span class="p">)</span>
            <span class="n">download_link</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;base64,</span><span class="si">{</span><span class="n">excel_data</span><span class="si">}</span><span class="s1">&quot; download=&quot;proc_params.xlsx&quot;&gt;📥 download!&lt;/a&gt;&#39;</span>
            <span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">params_df</span><span class="p">)</span>
        
        <span class="c1"># Session parameters sections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_session_parameters</span><span class="p">()</span>
        
        <span class="c1"># Full dataset section</span>
        <span class="k">if</span> <span class="s2">&quot;correction_output_full_dataset&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;All replicates&quot;</span><span class="p">):</span>
                <span class="n">full_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_full_dataset&quot;</span><span class="p">]</span>
                <span class="n">excel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span><span class="o">.</span><span class="n">create_excel_download</span><span class="p">(</span><span class="n">full_data</span><span class="p">)</span>
                <span class="n">download_link</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;base64,</span><span class="si">{</span><span class="n">excel_data</span><span class="si">}</span><span class="s1">&quot; download=&quot;replicates.xlsx&quot;&gt;📥 download!&lt;/a&gt;&#39;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">full_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Sample&quot;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="ProcessingPage._display_session_parameters">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._display_session_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_session_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display session parameters for each processed isotope.&quot;&quot;&quot;</span>
        <span class="n">isotope_configs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;47&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_sessions47&quot;</span><span class="p">,</span> <span class="s2">&quot;47params.xlsx&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;48&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_sessions48&quot;</span><span class="p">,</span> <span class="s2">&quot;48params.xlsx&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;49&quot;</span><span class="p">,</span> <span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_output_sessions49&quot;</span><span class="p">,</span> <span class="s2">&quot;49params.xlsx&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">mz</span><span class="p">,</span> <span class="n">process_key</span><span class="p">,</span> <span class="n">session_key</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">isotope_configs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">process_key</span><span class="p">)</span> <span class="ow">and</span> <span class="n">session_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">):</span>
                <span class="n">session_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="n">session_key</span><span class="p">]</span>
                
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$\Delta_</span><span class="se">{{</span><span class="si">{</span><span class="n">mz</span><span class="si">}</span><span class="se">}}</span><span class="s2">$ session parameters&quot;</span><span class="p">):</span>
                    <span class="n">excel_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">excel_exporter</span><span class="o">.</span><span class="n">create_excel_download</span><span class="p">(</span><span class="n">session_data</span><span class="p">)</span>
                    <span class="n">download_link</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;base64,</span><span class="si">{</span><span class="n">excel_data</span><span class="si">}</span><span class="s1">&quot; download=&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;&gt;📥 download!&lt;/a&gt;&#39;</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">download_link</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">session_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Session&quot;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="ProcessingPage._run_processing">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage._run_processing">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ProcessingConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the main processing workflow.&quot;&quot;&quot;</span>
        <span class="c1"># Validate configuration</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">scale</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ICDES&quot;</span><span class="p">,</span> <span class="s2">&quot;compile&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">process_D49</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;There are no I-CDES standard values for Δ49! &quot;</span>
                <span class="s2">&quot;Please choose CDES if you want to process Δ49 data using gas standards.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Processing in progress...&quot;</span><span class="p">):</span>
            <span class="c1"># Prepare data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_processing_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            
            <span class="c1"># Process isotopes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotope_processor</span><span class="o">.</span><span class="n">process_all_isotopes</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            
            <span class="c1"># Merge datasets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_processor</span><span class="o">.</span><span class="n">merge_datasets</span><span class="p">()</span>
            
            <span class="c1"># Clean up CSV text</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">csv_text</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Calculate long-term errors</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_longterm_error</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
        
        <span class="c1"># Calculate temperatures</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_temperatures</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        
        <span class="c1"># Store final summary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span>
        
        <span class="c1"># Extract standards data</span>
        <span class="n">standards_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_full_dataset&quot;</span><span class="p">][</span><span class="s2">&quot;Sample&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_SAMPLES</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">standards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">[</span><span class="s2">&quot;correction_output_full_dataset&quot;</span><span class="p">][</span><span class="n">standards_mask</span><span class="p">]</span>
        
        <span class="c1"># Update parameters tracking</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATE_PARAMS</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">params_last_run</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        
        <span class="c1"># Reset run button state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">show_run_button</span> <span class="o">=</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="ProcessingPage.run">
<a class="viewcode-back" href="../../04_Processing.html#pages.04_Processing.ProcessingPage.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main function to run the processing page.&quot;&quot;&quot;</span>
        <span class="c1"># Validate input data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input_data</span><span class="p">():</span>
            <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

                    
        <span class="c1"># Main processing button</span>
        <span class="n">run_button</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run...&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;BUTTON1&quot;</span><span class="p">,</span>
        <span class="c1">#disabled= not(</span>
        <span class="c1">#    self.sss.get(&quot;process_D47&quot;, False) or </span>
        <span class="c1">#    self.sss.get(&quot;process_D48&quot;, False) or </span>
        <span class="c1">#    self.sss.get(&quot;process_D49&quot;, False)</span>
                    <span class="c1">#)</span>
        <span class="p">)</span>
        
        <span class="c1"># Render input data editor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_render_input_data_editor</span><span class="p">()</span>
        
        <span class="c1"># Render sidebar controls and get configuration</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_sidebar_controls</span><span class="p">()</span>

        
        <span class="c1"># Handle processing execution</span>
        <span class="k">if</span> <span class="n">run_button</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D47&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D48&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;process_D49&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;## Please choose at least one of $\Delta_</span><span class="si">{47}</span><span class="s2">$, $\Delta_</span><span class="si">{48}</span><span class="s2">$, or $\Delta_</span><span class="si">{49}</span><span class="s2">$!&quot;</span>                    
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_processing</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_processing_summary</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_results_expanders</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Display existing results if available</span>
            <span class="k">if</span> <span class="s2">&quot;correction_output_summary&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sss</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_processing_summary</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_results_expanders</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
                    <span class="s2">&quot;Please choose processing parameters on the sidebar and &quot;</span>
                    <span class="s2">&quot;click the :violet[Run...] button to process the dataset.&quot;</span>
                <span class="p">)</span></div>
</div>



<span class="c1"># Main execution</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">ProcessingPage</span><span class="p">()</span>
    <span class="n">page</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Miguel Bernecker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>